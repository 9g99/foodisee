<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>FireBall Guide</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .wrapper {
      padding: 0 32px;
    }

    .title-container {
      margin-top: 40px;
      margin-bottom: 32px;
    }

    .title-main-wrapper {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }

    .title-main {
      font-size: 3.5rem;
      font-weight: bold;
      margin-bottom: 0;
      line-height: 1.2;
    }

    .logo-image {
      height: 64px;
      object-fit: contain;
      margin-left: 20px;
      margin-top: 4px;
    }

    @media (max-width: 600px) {
      .logo-image {
        height: 40px;
        margin-top: 3px;
      }
    }

    .title-sub {
      font-size: 2.5rem;
      color: #555;
      text-align: left;
      margin-top: 24px;
      line-height: 1.4;
    }

    .selected-location {
      font-size: 1.5rem;
      color: #333;
      margin-top: 16px;
      text-align: left;
    }

    .search-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      margin-bottom: 32px;
      gap: 16px;
    }

    #locationInput {
      flex-grow: 1;
      font-size: 2rem;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 9999px;
      outline: none;
      margin-right: 12px;
    }

    .button-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .button-group button {
      font-size: 2rem;
      border-radius: 9999px;
      cursor: pointer;
    }

    .button-group button:first-child {
      padding: 20px 24px;
      border: 1px solid #ccc;
      background-color: #007bff;
      color: white;
    }

    .button-group button:last-child {
      background: none;
      border: none;
      padding: 0;
    }

    .button-group img {
      height: 40px;
      width: 40px;
      margin-left: 12px;
      margin-right: 4px;
      display: block;
    }

    .card-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      padding: 0 32px;
    }

    .card {
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      width: 100%;
      padding: 16px;
      box-sizing: border-box;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 440px;
      transition: box-shadow 0.2s;
    }

    .card img.main-image {
      width: 100%;
      height: 260px;
      object-fit: cover;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      text-align: center;
    }

    .card-title {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .card-distance {
      font-size: 24px;
      color: #555;
    }

    .card a {
      text-decoration: none;
      color: inherit;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="title-container">
      <div class="title-main-wrapper">
        <div class="title-main">
          FireBall <span style="color: red;">Guide 1.0</span>
        </div>
        <img src="https://raw.githubusercontent.com/9g99/foodisee/refs/heads/main/IMG_2875.png" alt="FireBall Logo" class="logo-image" />
      </div>
      <div class="title-sub" id="locationTitle">My current location</div>
      <div id="selectedLocation" class="selected-location"></div>
    </div>

    <div class="search-container">
      <input type="text" id="locationInput" placeholder="ÏßÄÏó≠ ÎòêÎäî Ï£ºÏÜåÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî" />
      <div class="button-group">
        <button onclick="searchLocation()">Í≤ÄÏÉâ</button>
        <button onclick="refreshLocation()">
          <img src="https://9g99.github.io/foodisee/refresh.png" alt="ÏÉàÎ°úÍ≥†Ïπ®" />
        </button>
      </div>
    </div>

    <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1g6Nlmx4DX38L0t0UAZnNQVd9aRd9trw&ehbc=2E312F"
            width="100%" height="600" style="border:0; margin-bottom: 24px;" allowfullscreen="" loading="lazy"></iframe>
  </div>

  <div id="places" class="card-container"></div>

  <script>
    let userLat, userLng;
    let isCurrentLocation = true;

    function updateLocationTitle() {
      document.getElementById('locationTitle').textContent =
        isCurrentLocation ? 'My current location' : 'My select location';
    }

    function reverseGeocode(lat, lng, callback) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      fetch(url)
        .then(response => response.json())
        .then(data => callback(data.display_name))
        .catch(() => callback("Ï£ºÏÜå Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."));
    }

    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function renderPlacesFromJSON() {
      if (typeof userLat === 'undefined' || typeof userLng === 'undefined') {
        alert("ÏúÑÏπò Ï†ïÎ≥¥Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïÑ ÏùåÏãùÏ†êÏùÑ ÌëúÏãúÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
        return;
      }

      reverseGeocode(userLat, userLng, function(address) {
        document.getElementById('selectedLocation').textContent = address;
      });

      const container = document.getElementById('places');
      container.innerHTML = '';

      fetch('https://raw.githubusercontent.com/9g99/foodisee/main/data/stores.json')
        .then(response => {
          if (!response.ok) throw new Error("fetch Ïã§Ìå®");
          return response.json();
        })
        .then(data => {
          const places = data.map(place => {
            const distanceMeters = getDistanceFromLatLonInMeters(userLat, userLng, place.lat, place.lng);
            return { ...place, distanceMeters };
          });

          places.sort((a, b) => a.distanceMeters - b.distanceMeters);

          places.forEach(place => {
            const distanceKm = place.distanceMeters / 1000;
            const walkTimeMinutes = Math.round(place.distanceMeters / 66.7);

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}" target="_blank">
                <img class="main-image" src="${place.image}" alt="${place.name}">
                <div class="card-content">
                  <div class="card-title">${place.name}</div>
                  <div class="card-distance">${distanceKm.toFixed(1)} km Í±∞Î¶¨ ¬∑ Í±∏Ïñ¥ÏÑú ${walkTimeMinutes}Î∂Ñ</div>
                </div>
              </a>
            `;
            container.appendChild(card);
          });
        })
        .catch(err => {
          console.error("üö® fetch Ïã§Ìå®", err);
        });
    }

    function searchLocation() {
      const query = document.getElementById('locationInput').value;
      if (!query) return alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
      fetch(url)
        .then(response => response.json())
        .then(results => {
          if (results.length === 0) {
            alert("Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.");
            return;
          }

          const lat = parseFloat(results[0].lat);
          const lon = parseFloat(results[0].lon);

          userLat = lat;
          userLng = lon;
          isCurrentLocation = false;

          updateLocationTitle();
          renderPlacesFromJSON();
        });
    }

    function refreshLocation() {
      isCurrentLocation = true;
      const input = document.getElementById('locationInput');
      input.value = "";
      input.placeholder = "ÏßÄÏó≠ ÎòêÎäî Ï£ºÏÜåÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî";

      userLat = 37.5157;
      userLng = 126.9074;

      updateLocationTitle();
      renderPlacesFromJSON();
    }

    navigator.geolocation.getCurrentPosition(function(position) {
      userLat = position.coords.latitude;
      userLng = position.coords.longitude;
      renderPlacesFromJSON();
    }, function(error) {
      console.warn("Geolocation Ï†ëÍ∑º Ïã§Ìå®, ÏûÑÏãú Ï¢åÌëú ÏÇ¨Ïö©");
      refreshLocation();
    });
  </script>
</body>
</html>