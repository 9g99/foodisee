<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>一點一酒 내 주변 맛집 보기</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    /* 제목 영역 */
    .title-container {
      text-align: center;
      margin-top: 40px;
      margin-bottom: 32px;
    }
    .title-badge {
      display: inline-block;
      background-color: #e0f7fa;
      color: blue;
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 48px;
    }
    .title-main {
      font-size: 3.5rem;
      font-weight: bold;
      margin-bottom: 48px;
      line-height: 1.2;
    }
    .title-sub {
      font-size: 2.5rem;
      color: #555;
      line-height: 1.4;
    }

    /* 검색창 */
    .search-container {
      text-align: center;
      margin-bottom: 32px;
    }
    #locationInput {
      width: 70%;
      max-width: 400px;
      font-size: 1.2rem;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .search-container button {
      font-size: 1.2rem;
      padding: 10px 16px;
      margin-left: 8px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    .card-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 16px;
    }
    .card {
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      width: 100%;
      padding: 16px;
      box-sizing: border-box;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 480px;
      transition: box-shadow 0.2s;
    }
    .card img.main-image {
      width: 100%;
      height: 300px;
      object-fit: contain;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .card.my-location {
      height: 200px;
      justify-content: center;
    }
    .card.my-location img {
      display: none;
    }
    .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      text-align: center;
    }
    .card-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .card-address {
      font-size: 14px;
      color: #777;
      margin-bottom: 8px;
    }
    .card-distance {
      font-size: 16px;
      color: #555;
    }
    .card a {
      text-decoration: none;
      color: inherit;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>

<body>
  <div class="title-container">
    <div class="title-badge">一點一酒</div>
    <div class="title-main">한 점에 한 잔씩<br>제대로 맛있게</div>
    <div class="title-sub">내 주변에 FireBall 선정 맛집 보기</div>
  </div>

  <div class="search-container">
    <input type="text" id="locationInput" placeholder="지역 또는 주소를 검색하세요" />
    <button onclick="searchLocation()">검색</button>
  </div>

  <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1g6Nlmx4DX38L0t0UAZnNQVd9aRd9trw&ehbc=2E312F" width="100%" height="600" style="border:0; margin-bottom: 24px;" allowfullscreen="" loading="lazy"></iframe>

  <div id="places" class="card-container"></div>

  <script>
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function reverseGeocode(lat, lng, callback) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          callback(data.display_name);
        })
        .catch(() => {
          callback("주소 정보를 가져올 수 없습니다.");
        });
    }

    function renderPlaces(userLat, userLng) {
      const container = document.getElementById('places');
      container.innerHTML = '';

      reverseGeocode(userLat, userLng, function(address) {
        const myCard = document.createElement('div');
        myCard.className = 'card my-location';
        myCard.innerHTML = `
          <div class="card-title">선택한 위치</div>
          <div class="card-distance">${address}</div>
        `;
        container.appendChild(myCard);
      });

      fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://9g99.github.io/foodisee/foodisee.xml'))
        .then(response => response.json())
        .then(data => {
          const str = data.contents;
          const xml = new window.DOMParser().parseFromString(str, "text/xml");
          const placemarks = xml.getElementsByTagNameNS('*', 'Placemark');

          const places = Array.from(placemarks).map(pm => {
            const name = pm.getElementsByTagNameNS('*', 'name')[0]?.textContent || "맛집";
            const coordsText = pm.getElementsByTagNameNS('*', 'coordinates')[0]?.textContent || "";
            const [lng, latP] = coordsText.trim().split(',').map(Number);
            const distance = getDistanceFromLatLonInKm(userLat, userLng, latP, lng);
            return { name, lat: latP, lng, distance };
          });

          places.sort((a, b) => a.distance - b.distance);

          places.slice(0, 10).forEach((place, index) => {
            reverseGeocode(place.lat, place.lng, function(storeAddress) {
              const searchQuery = encodeURIComponent(place.name + ' ' + storeAddress);
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `
                <a href="https://www.google.com/maps/search/?api=1&query=${searchQuery}" target="_blank">
                  <img class="main-image" src="https://raw.githubusercontent.com/9g99/pjt/main/IMG_2875.png" alt="${place.name}">
                  <div class="card-content">
                    <div class="card-title">${place.name}</div>
                    <div class="card-address">${storeAddress}</div>
                    <div class="card-distance">${place.distance.toFixed(1)} km 거리</div>
                  </div>
                </a>
              `;
              container.appendChild(card);
            });
          });
        });
    }

    function searchLocation() {
      const query = document.getElementById('locationInput').value;
      if (!query) return alert("검색어를 입력해주세요.");

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

      fetch(url)
        .then(response => response.json())
        .then(results => {
          if (results.length === 0) {
            alert("검색 결과가 없습니다.");
            return;
          }
          const lat = parseFloat(results[0].lat);
          const lon = parseFloat(results[0].lon);
          renderPlaces(lat, lon);
        });
    }

    // 초기 위치 자동 탐색
    navigator.geolocation.getCurrentPosition(function(position) {
      renderPlaces(position.coords.latitude, position.coords.longitude);
    }, function(error) {
      alert('위치 정보 접근이 거부되었습니다. 검색창을 이용해주세요.');
    });
  </script>
</body>
</html>