<script>
  let userLat, userLng;

  function reverseGeocode(lat, lng, callback) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    fetch(url)
      .then(response => response.json())
      .then(data => callback(data.display_name))
      .catch(() => callback("주소 정보를 가져올 수 없습니다."));
  }

  function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function showMainContent() {
    document.getElementById('intro').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    document.body.style.overflow = 'auto';
  }

  function renderPlacesFromJSON(limit = 10) {
    reverseGeocode(userLat, userLng, function(address) {
      document.getElementById('selectedLocation').textContent = address;
    });

    const container = document.getElementById('places');
    container.innerHTML = '';

    fetch('https://raw.githubusercontent.com/9g99/foodisee/main/data/stores.json')
      .then(response => response.json())
      .then(data => {
        const places = data.map(place => {
          const distance = getDistanceFromLatLonInMeters(userLat, userLng, place.lat, place.lng);
          return { ...place, distanceMeters: distance };
        }).sort((a, b) => a.distanceMeters - b.distanceMeters)
          .slice(0, limit);

        places.forEach(place => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <img src="${place.image}" alt="${place.name}" />
            <div class="card-title">${place.name.replace('$1', '').trim()}</div>
            <div class="card-buttons">
              <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}" target="_blank">지도에서 보기</a>
              <a href="https://map.kakao.com/?sName=내위치&sX=${userLng}&sY=${userLat}&eName=${encodeURIComponent(place.name)}&eX=${place.lng}&eY=${place.lat}&by=FOOT" target="_blank">길찾기</a>
            </div>
          `;
          container.appendChild(card);
        });
      });
  }

  function searchLocation() {
    const query = document.getElementById('locationInput').value;
    if (!query) return alert("검색어를 입력해주세요.");

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(results => {
        if (results.length === 0) {
          alert("검색 결과가 없습니다.");
          return;
        }

        userLat = parseFloat(results[0].lat);
        userLng = parseFloat(results[0].lon);

        // URL 상태 갱신
        history.pushState({ mode: 'search' }, '', '?search=' + encodeURIComponent(query));

        showMainContent();
        renderPlacesFromJSON();
      });
  }

  function loadCurrentLocation() {
    navigator.geolocation.getCurrentPosition(function(position) {
      userLat = position.coords.latitude;
      userLng = position.coords.longitude;

      history.pushState({ mode: 'around' }, '', '?around');

      showMainContent();
      renderPlacesFromJSON();
    }, function() {
      alert("위치 접근에 실패했습니다.");
    });
  }

  function showNearestPlace() {
    navigator.geolocation.getCurrentPosition(function(position) {
      userLat = position.coords.latitude;
      userLng = position.coords.longitude;

      history.pushState({ mode: 'nearest' }, '', '?nearest');

      showMainContent();
      renderPlacesFromJSON(1);
    }, function() {
      alert("위치 접근에 실패했습니다.");
    });
  }

  // 최초 진입 시 URL 파라미터 감지
  document.addEventListener('DOMContentLoaded', function () {
    const params = new URLSearchParams(window.location.search);
    if (params.has('nearest')) {
      showNearestPlace();
    } else if (params.has('around')) {
      loadCurrentLocation();
    } else if (params.has('search')) {
      const query = params.get('search');
      document.getElementById('locationInput').value = query;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(results => {
          if (results.length > 0) {
            userLat = parseFloat(results[0].lat);
            userLng = parseFloat(results[0].lon);
            showMainContent();
            renderPlacesFromJSON();
          }
        });
    }
  });

  // 뒤로가기/앞으로가기 감지
  window.onpopstate = function () {
    const params = new URLSearchParams(location.search);
    if (params.has('nearest')) {
      showNearestPlace();
    } else if (params.has('around')) {
      loadCurrentLocation();
    } else if (params.has('search')) {
      const query = params.get('search');
      document.getElementById('locationInput').value = query;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(results => {
          if (results.length > 0) {
            userLat = parseFloat(results[0].lat);
            userLng = parseFloat(results[0].lon);
            showMainContent();
            renderPlacesFromJSON();
          }
        });
    } else {
      // 인트로 화면 복귀
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('intro').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
  };
</script>